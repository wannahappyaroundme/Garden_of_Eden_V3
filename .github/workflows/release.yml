name: Release

on:
  push:
    tags:
      - 'v*.*.*' # Trigger on semantic version tags (e.g., v1.0.0)
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: write

jobs:
  build:
    name: Build ${{ matrix.platform.name }}
    runs-on: ${{ matrix.platform.os }}

    strategy:
      fail-fast: false
      matrix:
        platform:
          - name: macOS (Apple Silicon)
            os: macos-latest
            target: aarch64-apple-darwin
            rust_target: aarch64-apple-darwin

          - name: macOS (Intel)
            os: macos-latest
            target: x86_64-apple-darwin
            rust_target: x86_64-apple-darwin

          - name: Windows
            os: windows-latest
            target: x86_64-pc-windows-msvc
            rust_target: x86_64-pc-windows-msvc

          - name: Linux
            os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            rust_target: x86_64-unknown-linux-gnu

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          # cache: 'npm' # Disabled - package-lock.json not committed

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform.rust_target }}

      - name: Install Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri -> target

      # macOS specific dependencies
      - name: Install macOS dependencies
        if: matrix.platform.os == 'macos-latest'
        run: |
          # Tauri requires no additional dependencies on macOS
          rustup target add ${{ matrix.platform.rust_target }}

      # Windows specific dependencies
      - name: Install Windows dependencies
        if: matrix.platform.os == 'windows-latest'
        run: |
          # Tauri requires WebView2 which is included in Windows 11 by default
          echo "Windows build environment ready"

      # Linux specific dependencies
      - name: Install Linux dependencies
        if: matrix.platform.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev \
            build-essential \
            curl \
            wget \
            file \
            libxdo-dev \
            libssl-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev

      - name: Install frontend dependencies
        run: npm ci

      - name: Install Tauri CLI
        run: cargo install tauri-cli --version "^2.0.0"

      - name: Build Tauri application
        env:
          # Disable code signing for unsigned builds
          APPLE_CODESIGN_IDENTITY: "-"
        run: |
          npm run build:renderer
          cargo tauri build --target ${{ matrix.platform.rust_target }}

      - name: Upload artifacts (macOS)
        if: matrix.platform.os == 'macos-latest'
        uses: actions/upload-artifact@v4
        with:
          name: Garden-of-Eden-${{ matrix.platform.target }}
          path: |
            src-tauri/target/${{ matrix.platform.rust_target }}/release/bundle/dmg/*.dmg
            src-tauri/target/${{ matrix.platform.rust_target }}/release/bundle/macos/*.app.tar.gz
          if-no-files-found: error
          retention-days: 7

      - name: Upload artifacts (Windows)
        if: matrix.platform.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: Garden-of-Eden-${{ matrix.platform.target }}
          path: |
            src-tauri/target/${{ matrix.platform.rust_target }}/release/bundle/msi/*.msi
            src-tauri/target/${{ matrix.platform.rust_target }}/release/bundle/nsis/*.exe
          if-no-files-found: error
          retention-days: 7

      - name: Upload artifacts (Linux)
        if: matrix.platform.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: Garden-of-Eden-${{ matrix.platform.target }}
          path: |
            src-tauri/target/${{ matrix.platform.rust_target }}/release/bundle/deb/*.deb
            src-tauri/target/${{ matrix.platform.rust_target }}/release/bundle/appimage/*.AppImage
          if-no-files-found: error
          retention-days: 7

  publish:
    name: Publish Release
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display artifact structure
        run: ls -R artifacts

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Generate release notes
        id: notes
        run: |
          cat > release-notes.md << 'EOF'
          ## ðŸŒŸ Garden of Eden V3 - Release v${{ steps.version.outputs.VERSION }}

          ### ðŸ“¦ Downloads

          #### macOS
          - **Apple Silicon (M1/M2/M3/M4)**: `Garden-of-Eden-*-aarch64-apple-darwin.dmg`
          - **Intel (x86_64)**: `Garden-of-Eden-*-x86_64-apple-darwin.dmg`

          #### Windows
          - **Installer (Recommended)**: `Garden-of-Eden-*-setup.exe` (NSIS installer)
          - **MSI Package**: `Garden-of-Eden-*.msi` (Windows Installer)

          #### Linux
          - **Debian/Ubuntu**: `Garden-of-Eden-*.deb` (DEB package)
          - **AppImage (Universal)**: `Garden-of-Eden-*.AppImage` (Portable)

          ### ðŸš€ Installation Instructions

          #### macOS
          1. Download the appropriate DMG file for your Mac's processor
          2. Open the DMG file
          3. Drag "Garden of Eden V3" to your Applications folder
          4. **First launch**: Right-click the app and select "Open" (to bypass Gatekeeper warning)
          5. On first run, the app will download AI models (~16GB via Ollama)

          #### Windows
          1. Download the `.exe` installer (recommended) or `.msi` file
          2. Run the installer
             - You may see a SmartScreen warning â†’ Click "More info" â†’ "Run anyway"
          3. Follow the installation wizard
          4. On first run, the app will download AI models (~16GB via Ollama)

          #### Linux
          1. **Debian/Ubuntu (DEB)**:
             ```bash
             sudo dpkg -i Garden-of-Eden-*.deb
             sudo apt-get install -f  # Install dependencies if needed
             ```
          2. **AppImage (Universal)**:
             ```bash
             chmod +x Garden-of-Eden-*.AppImage
             ./Garden-of-Eden-*.AppImage
             ```
          3. On first run, the app will download AI models (~16GB via Ollama)

          ### âš™ï¸ System Requirements

          - **RAM**: 16GB minimum, **24GB+ recommended**
          - **Disk Space**: 20GB free (for app + AI models)
          - **OS**: macOS 12+, Windows 10/11, or Linux (Ubuntu 20.04+, Debian 11+)
          - **CPU**: Apple Silicon (M1+) or Intel i5 8th gen+ / AMD Ryzen 5+
          - **GPU**: Metal (macOS) or CUDA-capable GPU recommended for best performance

          ### âœ¨ What's New

          See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for detailed changes in this release.

          ### ðŸ”’ Privacy & Security

          - âœ… **100% Local AI** - All processing happens on your computer
          - âœ… **Zero Cloud Dependency** - No data sent to external servers
          - âœ… **Encrypted Storage** - AES-256 encryption for sensitive data
          - âœ… **No Telemetry** - No analytics, tracking, or data collection
          - âœ… **Works Offline** - Full functionality without internet after setup
          - âœ… **Open Source** - Auditable code (MIT License)

          ### ðŸ“– Documentation

          - [Quick Start Guide](https://github.com/${{ github.repository }}/blob/main/README.md#-quick-start)
          - [Complete Specification](https://github.com/${{ github.repository }}/blob/main/PROJECT_EDEN_V3_MASTER_SPEC.md)
          - [Known Issues](https://github.com/${{ github.repository }}/blob/main/KNOWN_ISSUES.md)
          - [Contributing Guidelines](https://github.com/${{ github.repository }}/blob/main/CONTRIBUTING.md)

          ### ðŸ› Reporting Issues

          Found a bug? [Open an issue](https://github.com/${{ github.repository }}/issues)

          ### ðŸ’¬ Community

          - [GitHub Discussions](https://github.com/${{ github.repository }}/discussions) - Q&A and ideas
          - [Discord Server](https://discord.gg/garden-of-eden) - Real-time chat (coming soon)

          ---

          **Built with ðŸ’š by Solo Developer with Production-Quality Standards**

          **Current AI Models**: Qwen 2.5 14B Instruct (9GB), Whisper Large V3 (3.1GB), LLaVA 7B (4.4GB)
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Garden of Eden V3 v${{ steps.version.outputs.VERSION }}
          body_path: release-notes.md
          draft: true # Set to true for manual review before publishing
          prerelease: false
          files: |
            artifacts/**/*.dmg
            artifacts/**/*.app.tar.gz
            artifacts/**/*.msi
            artifacts/**/*.exe
            artifacts/**/*.deb
            artifacts/**/*.AppImage
          generate_release_notes: false # We're providing custom notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release summary
        run: |
          echo "âœ… Release v${{ steps.version.outputs.VERSION }} created successfully!"
          echo ""
          echo "ðŸ“¦ Artifacts uploaded:"
          find artifacts -type f \( -name "*.dmg" -o -name "*.app.tar.gz" -o -name "*.msi" -o -name "*.exe" -o -name "*.deb" -o -name "*.AppImage" \) -exec ls -lh {} \;
